<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Commerce Share</title>

  <!-- Kakao JavaScript SDK -->
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font: 16px/1.4 system-ui;
      margin: 0;
      text-align: center;
    }
    .loading {
      color: #666;
    }
  </style>
</head>
<body>
  <div class="loading">ê³µìœ  ì¤€ë¹„ ì¤‘...</div>

  <script>
    /**
     * ì¹´ì¹´ì˜¤ ì»¤ë¨¸ìŠ¤ ê³µìœ  ê¸°ëŠ¥
     * ìƒí’ˆ ì •ë³´ì™€ ê°€ê²©ì„ í¬í•¨í•œ ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
     */

    /* 1. SDK ì´ˆê¸°í™” */
    Kakao.init('6b711b9da95847ae14bd5ee043cc44db');   // ğŸ”¸ì‹¤ì œ JS í‚¤ë¡œ êµì²´

    /* 2. URL íŒŒë¼ë¯¸í„° íŒŒì‹± */
    /**
     * ì˜ˆìƒ ì¿¼ë¦¬ í˜•ì‹:
     * kakao-share.html?u=ENCODED_URL&t=ENCODED_TITLE&i=ENCODED_IMG&rp=10000&dp=8000&dr=20
     * - u: ê³µìœ  URL (ì¸ì½”ë”©ë¨)
     * - t: ì œëª© (ì¸ì½”ë”©ë¨)
     * - i: ì´ë¯¸ì§€ URL (ì¸ì½”ë”©ë¨)
     * - rp: ì •ê°€(regularPrice)
     * - dp: í• ì¸ê°€(discountPrice)
     * - dr: í• ì¸ìœ¨(discountRate, %)
     */
    const params = new URLSearchParams(location.search);

    const url = decodeURIComponent(params.get('u') || location.origin);
    const title = decodeURIComponent(params.get('t') || 'ê³µë™êµ¬ë§¤ ì´ë²¤íŠ¸');
    const imageUrl = decodeURIComponent(params.get('i') || '');

	const link = 'https://app.weaverloft.com/group_buying/assets/html/redirect.html?url=' + encodeURIComponent(url);
    
    let regularPrice = parseInt(params.get('rp'), 10) || 0;
    let discountPrice = parseInt(params.get('dp'), 10) || 0;
    let discountRate = parseInt(params.get('dr'), 10) || 0;

    /* 3. (ì˜µì…˜) openerì—ì„œ ë°ì´í„° ë³´ê°• */
    // ê°™ì€ ë„ë©”ì¸ì¼ ê²½ìš° openerì—ì„œ .gb-* í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œ
    try {
      if (window.opener && window.opener.document) {
        const $ = window.opener.document.querySelector.bind(window.opener.document);

        if (!regularPrice) {
          const priceText = $('.gb-original-price')?.textContent;
          regularPrice = priceText ? parseInt(priceText.replace(/[^0-9]/g, ''), 10) : 0;
        }
        
        if (!discountPrice) {
          const priceText = $('.gb-discount-price')?.textContent;
          discountPrice = priceText ? parseInt(priceText.replace(/[^0-9]/g, ''), 10) : 0;
        }
        
        if (!discountRate) {
          const rateText = $('.gb-discount-rate')?.textContent;
          discountRate = rateText ? parseInt(rateText.replace(/[^0-9]/g, ''), 10) : 0;
        }
      }
    } catch (e) {
      console.warn('opener ì ‘ê·¼ ì‹¤íŒ¨ (êµì°¨ ë„ë©”ì¸ì¼ ê°€ëŠ¥ì„± ìˆìŒ)');
    }

    /* 4. ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì‹¤í–‰ */
    (async () => {
      try {
        await Kakao.Share.sendDefault({
          objectType: 'commerce',
          content: {
            title,
            description: 'ê³µë™êµ¬ë§¤ íŠ¹ë³„ ê°€ê²©ìœ¼ë¡œ êµ¬ë§¤í•˜ì„¸ìš”!',
            imageUrl,
            link: { 
              mobileWebUrl: link, 
              webUrl: link 
            }
          },
          commerce: {
            productName: title,
            regularPrice,
            discountRate,
            discountPrice
          },
          buttons: [{
            title: 'ê³µë™êµ¬ë§¤ ì°¸ì—¬í•˜ê¸°',
            link: { 
              mobileWebUrl: link, 
              webUrl: link 
            }
          }]
        });
      } catch (e) {
        console.error('ì¹´ì¹´ì˜¤ ê³µìœ  ì‹¤íŒ¨:', e);
        alert('ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        navigator.clipboard.writeText(link);
      } finally {
        window.close();   // ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ í›„ íŒì—… ë‹«ê¸°
      }
    })();
  </script>
</body>
</html>
